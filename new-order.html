<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Pedido - Color Cart Buddy</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: 2rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .back-button:hover {
            color: var(--primary-hover);
        }
        
        .order-summary {
            background: var(--background-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .order-summary h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-total {
            border-top: 2px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                padding: 1.5rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Voltar ao Início
        </a>

        <header class="hero-section">
            <h1>Novo Pedido</h1>
            <p>Crie um novo pedido selecionando produtos e informando dados de entrega</p>
        </header>

        <div class="form-container">
            <form id="orderForm">
                <h2 style="color: var(--primary-color); margin-bottom: 2rem;">Informações do Pedido</h2>

                <!-- Product Items Container -->
                <div id="productItemsContainer"></div>
                <button type="button" id="addProductBtn" class="btn btn-secondary" style="margin-bottom: 1.5rem;">
                    Adicionar Produto
                </button>

                <div class="form-group">
                    <label for="cnpj">CNPJ *</label>
                    <input type="text" id="cnpj" name="cnpj" required placeholder="00.000.000/0000-00" />
                </div>

                <h3 style="color: var(--primary-color); margin: 2rem 0 1rem 0;">Dados de Entrega</h3>

                <div class="form-group">
                    <label for="customerName">Nome Completo *</label>
                    <input type="text" id="customerName" name="customerName" required placeholder="Digite seu nome completo" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Telefone *</label>
                        <input type="tel" id="phone" name="phone" required placeholder="(11) 99999-9999" />
                    </div>
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" placeholder="seu@email.com" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Endereço *</label>
                    <input type="text" id="address" name="address" required placeholder="Rua, número" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">Cidade *</label>
                        <input type="text" id="city" name="city" required placeholder="Cidade" />
                    </div>
                    <div class="form-group">
                        <label for="state">Estado *</label>
                        <select id="state" name="state" required>
                            <option value="">Selecione</option>
                            <option value="SP">São Paulo</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="PR">Paraná</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="BA">Bahia</option>
                            <option value="GO">Goiás</option>
                            <option value="PE">Pernambuco</option>
                            <option value="CE">Ceará</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cep">CEP *</label>
                        <input type="text" id="cep" name="cep" required placeholder="00000-000" />
                    </div>
                    <div class="form-group">
                        <label for="deliveryDate">Data de Entrega Preferida</label>
                        <input type="date" id="deliveryDate" name="deliveryDate" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="observations">Observações</label>
                    <textarea id="observations" name="observations" rows="3" placeholder="Informações adicionais sobre o pedido"></textarea>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <h3>Resumo do Pedido</h3>
                    <div id="orderSummaryItems"></div>
                    <div class="summary-item summary-total">
                        <span>Total:</span>
                        <span id="summaryTotal">R$ 0,00</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 2rem; width: 100%;">
                    Finalizar Pedido
                </button>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('orderForm');
            const productSelect = document.getElementById('product');
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unitPrice');
            const cepInput = document.getElementById('cep');
            const phoneInput = document.getElementById('phone');
            const cnpjInput = document.getElementById('cnpj');

            // Load products into select dropdown
            loadProducts();

            // Update order summary when product or quantity changes
            function updateOrderSummary() {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const quantity = parseInt(quantityInput.value) || 0;
                const price = parseFloat(selectedOption.dataset.price) || 0;
                const total = quantity * price;

                document.getElementById('summaryProduct').textContent = 
                    selectedOption.text.split(' - ')[0] || '-';
                document.getElementById('summaryQuantity').textContent = quantity || '-';
                document.getElementById('summaryUnitPrice').textContent = 
                    price ? `R$ ${price.toFixed(2).replace('.', ',')}` : '-';
                document.getElementById('summaryTotal').textContent = 
                    `R$ ${total.toFixed(2).replace('.', ',')}`;
                
                unitPriceInput.value = price ? `R$ ${price.toFixed(2).replace('.', ',')}` : '';
            }

            // Format CEP input
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
                e.target.value = value;
            });

            // Format phone input
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            });

            // Format CNPJ input
            cnpjInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 14) {
                    value = value.replace(/(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    value = value.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4');
                    value = value.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
                }
                e.target.value = value;
            });

            // Event listeners
            productSelect.addEventListener('change', updateOrderSummary);
            quantityInput.addEventListener('input', updateOrderSummary);

            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!window.ColorCartBuddy.validateForm(form)) {
                    return;
                }

                // Simulate order processing
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.textContent = 'Processando...';
                submitButton.disabled = true;

                setTimeout(() => {
                    // Save order to localStorage
                    const rawTotal = document.getElementById('summaryTotal').textContent;
                    const computedTotal = parseFloat(rawTotal.replace('R$', '').trim().replace(',', '.')) || 0;
                    
                    const orderData = {
                        id: Date.now(),
                        product: productSelect.options[productSelect.selectedIndex].text,
                        quantity: quantityInput.value,
                        customerName: document.getElementById('customerName').value,
                        phone: phoneInput.value,
                        address: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        cep: cepInput.value,
                        total: computedTotal,
                        date: new Date().toLocaleDateString('pt-BR'),
                        status: 'Pendente'
                    };

                    const orders = window.ColorCartBuddy.getFromLocalStorage('orders') || [];
                    orders.push(orderData);
                    window.ColorCartBuddy.saveToLocalStorage('orders', orders);

                    window.ColorCartBuddy.showSuccessMessage('Pedido criado com sucesso!');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }, 1500);
            });

            // Initialize summary
            updateOrderSummary();
        });

        function loadProducts() {
            const productSelect = document.getElementById('product');
            const products = window.ColorCartBuddy ? window.ColorCartBuddy.getProducts() : [];
            
            // Clear existing options except the first one
            while (productSelect.children.length > 1) {
                productSelect.removeChild(productSelect.lastChild);
            }
            
            if (products.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum produto disponível - Cadastre produtos primeiro';
                option.disabled = true;
                productSelect.appendChild(option);
                return;
            }
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = `product-${product.id}`;
                option.dataset.price = product.price;
                option.dataset.productId = product.id;
                option.textContent = `${product.name} - R$ ${product.price.toFixed(2).replace('.', ',')}`;
                productSelect.appendChild(option);
            });
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productItemsContainer = document.getElementById('productItemsContainer');
            const addProductBtn = document.getElementById('addProductBtn');
            const orderForm = document.getElementById('orderForm');
            const orderSummaryItems = document.getElementById('orderSummaryItems');
            const summaryTotal = document.getElementById('summaryTotal');

            // Load initial product line item
            addProductLineItem();

            // Add new product line item on button click
            addProductBtn.addEventListener('click', () => {
                addProductLineItem();
            });

            // Handle form submission
            orderForm.addEventListener('submit', (e) => {
                e.preventDefault();

                if (!window.ColorCartBuddy.validateForm(orderForm)) {
                    return;
                }

                // Gather order data
                const productLines = productItemsContainer.querySelectorAll('.product-line-item');
                const itens = [];

                for (const line of productLines) {
                    const productSelect = line.querySelector('.product-select');
                    const quantityInput = line.querySelector('.product-quantity');
                    const unitPriceInput = line.querySelector('.product-unit-price');

                    if (!productSelect.value || !quantityInput.value) {
                        window.ColorCartBuddy.showErrorMessage('Preencha todos os produtos e quantidades.');
                        return;
                    }

                    // Parse unit price from formatted string
                    const unitPriceText = unitPriceInput.value.replace('R$', '').trim().replace(',', '.');
                    const unitPrice = parseFloat(unitPriceText) || 0;

                    itens.push({
                        productId: productSelect.dataset.productId,
                        productName: productSelect.options[productSelect.selectedIndex].text,
                        quantity: parseInt(quantityInput.value),
                        unitPrice: unitPrice
                    });
                }

                if (itens.length === 0) {
                    window.ColorCartBuddy.showErrorMessage('Adicione pelo menos um produto ao pedido.');
                    return;
                }

                // Calculate total value
                let computedTotal = 0;
                itens.forEach(item => {
                    computedTotal += item.quantity * item.unitPrice;
                });

                const orderData = {
                    id: Date.now(),
                    itens,
                    cnpj: document.getElementById('cnpj').value.trim(),
                    customerName: document.getElementById('customerName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    city: document.getElementById('city').value.trim(),
                    state: document.getElementById('state').value,
                    cep: document.getElementById('cep').value.trim(),
                    deliveryDate: document.getElementById('deliveryDate').value,
                    observations: document.getElementById('observations').value.trim(),
                    date: new Date().toLocaleDateString('pt-BR'),
                    status: 'Pendente',
                    total: computedTotal
                };

                const orders = window.ColorCartBuddy.getFromLocalStorage('orders') || [];
                orders.push(orderData);
                window.ColorCartBuddy.saveToLocalStorage('orders', orders);

                window.ColorCartBuddy.showSuccessMessage('Pedido criado com sucesso!');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            });

            // Add a product line item to the container
            function addProductLineItem() {
                const line = document.createElement('div');
                line.className = 'product-line-item';
                line.style.display = 'flex';
                line.style.gap = '1rem';
                line.style.marginBottom = '1rem';
                line.style.alignItems = 'center';

                // Product select
                const productSelect = document.createElement('select');
                productSelect.className = 'product-select';
                productSelect.required = true;
                productSelect.style.flex = '2';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecione um produto';
                productSelect.appendChild(defaultOption);

                const products = window.ColorCartBuddy.getProducts();
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name + ' - R$ ' + product.price.toFixed(2).replace('.', ',');
                    option.dataset.price = product.price;
                    option.dataset.productId = product.id;
                    productSelect.appendChild(option);
                });

                // Quantity input
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'product-quantity';
                quantityInput.min = '1';
                quantityInput.value = '1';
                quantityInput.required = true;
                quantityInput.style.flex = '1';

                // Unit price input (read-only)
                const unitPriceInput = document.createElement('input');
                unitPriceInput.type = 'text';
                unitPriceInput.className = 'product-unit-price';
                unitPriceInput.readOnly = true;
                unitPriceInput.style.flex = '1';
                unitPriceInput.style.backgroundColor = '#f7fafc';

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Remover';
                removeBtn.className = 'btn btn-secondary';
                removeBtn.style.flex = '0.5';

                removeBtn.addEventListener('click', () => {
                    line.remove();
                    updateOrderSummary();
                });

                // Update unit price when product changes
                productSelect.addEventListener('change', () => {
                    const selectedOption = productSelect.options[productSelect.selectedIndex];
                    const price = parseFloat(selectedOption.dataset.price) || 0;
                    unitPriceInput.value = price ? `R$ ${price.toFixed(2).replace('.', ',')}` : '';
                    updateOrderSummary();
                });

                // Update summary when quantity changes
                quantityInput.addEventListener('input', () => {
                    updateOrderSummary();
                });

                line.appendChild(productSelect);
                line.appendChild(quantityInput);
                line.appendChild(unitPriceInput);
                line.appendChild(removeBtn);

                productItemsContainer.appendChild(line);
                updateOrderSummary();
            }

            // Update order summary display
            function updateOrderSummary() {
                const lines = productItemsContainer.querySelectorAll('.product-line-item');
                orderSummaryItems.innerHTML = '';
                let total = 0;

                lines.forEach(line => {
                    const productSelect = line.querySelector('.product-select');
                    const quantityInput = line.querySelector('.product-quantity');
                    const unitPriceInput = line.querySelector('.product-unit-price');

                    if (!productSelect.value) return;

                    const productName = productSelect.options[productSelect.selectedIndex].text;
                    const quantity = parseInt(quantityInput.value) || 0;
                    const unitPrice = parseFloat(unitPriceInput.value.replace('R$ ', '').replace(',', '.')) || 0;
                    const lineTotal = quantity * unitPrice;
                    total += lineTotal;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'summary-item';
                    itemDiv.style.display = 'flex';
                    itemDiv.style.justifyContent = 'space-between';
                    itemDiv.style.marginBottom = '0.5rem';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${productName} x${quantity}`;

                    const priceSpan = document.createElement('span');
                    priceSpan.textContent = `R$ ${lineTotal.toFixed(2).replace('.', ',')}`;

                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(priceSpan);
                    orderSummaryItems.appendChild(itemDiv);
                });

                summaryTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            }
        });
    </script>
</body>
</html>
